#!/bin/bash 
#******************************************************************************
#
# * File: fetchpkg
#
# * Author:  Umut Sevdi
# * Created: 01/15/23
# * Description: A script that displays available upgrades for the applications on 
# APT and Flatpak.
# It will create a notification if the amount is greater than 5. Clicking to the
# notification will prompt a password to upgrade the applications
# * @require zenity, APT, flatpak
#*****************************************************************************

apt-get update
Update() {
    password=`zenity --password --title="Update $UPDATE applications." --ok-label="Update"`
    if [ -n "$password" ]; then 
        flatpak update <<< "Y" &
        echo $password | sudo -S sh -c 'apt update -y'
        echo $password | sudo -S sh -c 'apt upgrade -y' &
    fi
}

Check() {
    APT=`sh -c 'apt list --upgradable' | wc -l`
    FLATPAK=$(( `flatpak update <<< "n" | wc -l` - 5 ))
    (( $FLATPAK < 0 )) && FLATPAK=0
    UPDATE=$(( $FLATPAK + $APT ))
    PKG=$UPDATE/`sh -c 'apt list --installed' | wc -l`

    if (( $UPDATE > 5 )); then
        clicked=`notify-send --app-name="Package Manager" --category="Package Manager" \
            "Package Manager" "There are $UPDATE updates available." --icon="software-update-available" \
            --action="[ACTION]action"`
        if [ "0" = "$clicked" ]; then
            Update
        fi
        echo " 󱧘  $PKG "
    else echo "  "
    fi
}

for arg in $@;do
    if   [ "$arg" = "--force-update" ] || [ "$arg" = "-f" ]; then
        Update
        exit
    fi
done
Check
