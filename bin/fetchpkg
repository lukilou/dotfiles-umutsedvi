#!/bin/bash 
#******************************************************************************
#
# * File: fetchpkg
#
# * Author:  Umut Sevdi
# * Created: 01/15/23
# * Description: A script that displays available upgrades for the applications on 
# APT and Flatpak.
# It will create a notification if the amount is greater than 5. Clicking to the
# notification will prompt a password to upgrade the applications
# * @require zenity, APT, flatpak
#*****************************************************************************

# Fetch function is run by ../services/fetchpkg.service every 2 hours to fetch
# updated packages
Service() {
    apt-get update
}

Fetch() {
    APT=`apt list --upgradable | tail -n +2 | grep ".*/" -o | tr -d "/"`
    FLATPAK=`flatpak update <<<  no | tail -n +4 | head -n -2 | awk '{print $2}'`
    APT_N=`wc -l <<< "$APT"`
    FPK_N=`wc -l <<< "$FLATPAK"`
    UPDATE=$(( $FLATPAK_N + $APT_N ))
}

Update() {
    # Fetch
    response=$(zenity --forms --title="Package Manager" \
        --text="There are $UPDATE updates available" \
        --add-list="APT($APT_N):" --list-values=`echo  "$APT" | tr " \n" "|"` \
        --add-list="Flatpak($FPK_N):" --list-values=`echo "$FLATPAK" | tr "\n" "|"` \
        --add-password="Password")
    password=`echo $response | sed "s/|/\n/g" | tail -n 1`
    if [ -n "$password" ]; then 
        flatpak update <<< "Y" &
        echo $password | sudo -S sh -c 'apt update -y' >> /tmp/fetchpkg.log
        echo $password | sudo -S sh -c 'apt upgrade -y' & >> /tmp/fetchpkg.log
    fi
}

DisplayUi() {
    Fetch
    PKG=$UPDATE/`sh -c 'apt list --installed' | wc -l`
    if (( $UPDATE > 5 )); then
        clicked=`notify-send --app-name="Package Manager" --category="Package Manager" \
            "Package Manager" "There are $UPDATE updates available." --icon="software-update-available" \
            --action="[ACTION]action"`
        if [ "0" = "$clicked" ]; then
            Update
        fi
        echo " 󱧘  $PKG "
    else echo "  "
    fi
}

for arg in $@;do
    if   [ "$arg" = "--fetch-only" ] || [ "$arg" = "-f" ]; then
        Service
        exit
    fi
    if   [ "$arg" = "--upgrade" ] || [ "$arg" = "-u" ]; then
        Update
        exit
    fi
done
DisplayUi
