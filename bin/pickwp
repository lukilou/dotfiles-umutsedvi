#!/bin/bash
#******************************************************************************
#
# * File: pickwp
#
# * Author:  Umut Sevdi
# * Created: 08/20/22
# * Description: A script that randomly picks a wallpaper from a directory.
# Selects a different wallpaper on each use.
# * @require nitrogen, xrandr
#*****************************************************************************

if ! command -v nitrogen &> /dev/null ; then
    echo "nitrogen doesn't exist" 1>&2
    exit
elif ! command -v xrandr &> /dev/null ; then
    echo "xrandr doesn't exist" 1>&2
    exit
fi

# Default wallpaper search path
path="/usr/share/backgrounds/"
# Default monitor count
head=`xrandr -q | grep ' connected' | awk '{print $1}' | tr '\n' ' '`
head_count=`xrandr -q | grep ' connected' | awk '{print $1}' | tr '\n' ' ' | wc -w`

Help()
{
   # Display Help
   echo "pickwp - Wallpaper Picker"
   echo "  Picks a random wallpaper from your wallpaper directory. Does not"
   echo "repeat same wallpaper twice" 
   echo
   echo "Syntax: [-h/c|m]"
   echo
   echo "Options:"
   echo "-h/--help            Prints this menu."
   echo "-s/--same            Draws the existing wallpaper again to the \
       existing monitors."
   echo "-d/--directory \$DIR     Picks wallpaper from custom directory."
   echo
}

Pick()
{
    # Check if directory exists or whether it contains an item
    if [ ! -d $path ] && [ `ls $path | wc -l` -gt 0 ]; then
        echo "Error: Wallpaper directory $path does not exist" 1>&2
        exit
    fi

    new_img=`find $path/  ! -name '*.xml' -type f  | shuf -n 1  2> /dev/null`
    old_img=`cat /tmp/.img  2> /dev/null`
    if [ "$pick_same" = true ] && [ -n "$old_img" ]; then
        new_img=$old_img
    else
        while [ $new_img = "$old_img" ]; do
            new_img=`find $path/  ! -name '*.xml' -type f | shuf -n 1  2> /dev/null`
        done
    fi

    echo $new_img > /tmp/.img
    echo "selected wallpaper: $new_img"

    for (( i=0; i < $head_count; i++ )); do 
        nitrogen --set-scaled --head=$i $new_img --save 2>/dev/null
        echo wallpaper applied to `cut -d " " -f $(($i+1)) <<< $head`
    done
}

for arg in $@; do
    if [ $arg = -h ] || [ $arg = --help ]; then
        Help
        exit
    elif [ $arg = -s ] || [ $arg = --same ]; then
        pick_same=true
        exit
    elif [ $arg = -d ] || [ $arg = --directory ]; then
        get_dir=true
    elif [ $get_dir = true ]; then
        path=$arg
        get_dir=false
    else
        echo -e "Error: Invalid arguments" 1>&2
        exit
    fi
done

# If there are no arguments pick from default directory
Pick
